name: Beta Release

# Manual trigger for beta releases from develop branch
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Beta version (e.g., 2.8.0-beta.1)'
        required: true
        type: string
      dry_run:
        description: 'Test build without creating release'
        required: false
        default: false
        type: boolean

jobs:
  validate-version:
    name: Validate beta version format
    runs-on: ubuntu-latest
    steps:
      - name: Validate version format
        run: |
          VERSION="${{ github.event.inputs.version }}"

          # Check if version matches beta semver pattern
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+-(beta|alpha|rc)\.[0-9]+$ ]]; then
            echo "::error::Invalid version format: $VERSION"
            echo "Version must match pattern: X.Y.Z-beta.N (e.g., 2.8.0-beta.1)"
            exit 1
          fi

          echo "Valid beta version: $VERSION"

  update-version:
    name: Update package.json version
    needs: validate-version
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: develop
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Update package.json version
        id: version
        run: |
          VERSION="${{ github.event.inputs.version }}"

          # Update frontend package.json
          cd apps/frontend
          npm version "$VERSION" --no-git-tag-version

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Updated package.json to version $VERSION"

      - name: Commit version bump
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          VERSION="${{ github.event.inputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          # Stage all changed files in frontend directory (handles package-lock.json if it exists)
          git add -A apps/frontend/
          git commit -m "chore: bump version to $VERSION for beta release"
          git push origin develop

      - name: Create and push tag
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          VERSION="${{ github.event.inputs.version }}"
          git tag -a "v$VERSION" -m "Beta release v$VERSION"
          git push origin "v$VERSION"
          echo "Created tag v$VERSION"

  # Intel build on Intel runner for native compilation
  build-macos-intel:
    needs: update-version
    runs-on: macos-15-intel
    steps:
      - uses: actions/checkout@v4
        with:
          # Use tag for real releases, develop branch for dry runs
          ref: ${{ github.event.inputs.dry_run == 'true' && 'develop' || format('v{0}', needs.update-version.outputs.version) }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Get npm cache directory
        id: npm-cache
        run: echo "dir=$(npm config get cache)" >> $GITHUB_OUTPUT

      - uses: actions/cache@v4
        with:
          path: ${{ steps.npm-cache.outputs.dir }}
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: ${{ runner.os }}-npm-

      - name: Install dependencies
        run: cd apps/frontend && npm ci

      - name: Cache bundled Python
        uses: actions/cache@v4
        with:
          path: apps/frontend/python-runtime
          key: python-bundle-${{ runner.os }}-x64-3.12.8
          restore-keys: |
            python-bundle-${{ runner.os }}-x64-

      - name: Build application
        run: cd apps/frontend && npm run build

      - name: Package macOS (Intel)
        run: cd apps/frontend && npm run package:mac -- --x64
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_LINK: ${{ secrets.MAC_CERTIFICATE }}
          CSC_KEY_PASSWORD: ${{ secrets.MAC_CERTIFICATE_PASSWORD }}

      - name: Notarize macOS Intel app
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          if [ -z "$APPLE_ID" ]; then
            echo "Skipping notarization: APPLE_ID not configured"
            exit 0
          fi
          cd apps/frontend
          for dmg in dist/*.dmg; do
            echo "Notarizing $dmg..."
            xcrun notarytool submit "$dmg" \
              --apple-id "$APPLE_ID" \
              --password "$APPLE_APP_SPECIFIC_PASSWORD" \
              --team-id "$APPLE_TEAM_ID" \
              --wait
            xcrun stapler staple "$dmg"
            echo "Successfully notarized and stapled $dmg"
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-intel-builds
          path: |
            apps/frontend/dist/*.dmg
            apps/frontend/dist/*.zip

  # Apple Silicon build on ARM64 runner for native compilation
  build-macos-arm64:
    needs: update-version
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4
        with:
          # Use tag for real releases, develop branch for dry runs
          ref: ${{ github.event.inputs.dry_run == 'true' && 'develop' || format('v{0}', needs.update-version.outputs.version) }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Get npm cache directory
        id: npm-cache
        run: echo "dir=$(npm config get cache)" >> $GITHUB_OUTPUT

      - uses: actions/cache@v4
        with:
          path: ${{ steps.npm-cache.outputs.dir }}
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: ${{ runner.os }}-npm-

      - name: Install dependencies
        run: cd apps/frontend && npm ci

      - name: Cache bundled Python
        uses: actions/cache@v4
        with:
          path: apps/frontend/python-runtime
          key: python-bundle-${{ runner.os }}-arm64-3.12.8
          restore-keys: |
            python-bundle-${{ runner.os }}-arm64-

      - name: Build application
        run: cd apps/frontend && npm run build

      - name: Package macOS (Apple Silicon)
        run: cd apps/frontend && npm run package:mac -- --arm64
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_LINK: ${{ secrets.MAC_CERTIFICATE }}
          CSC_KEY_PASSWORD: ${{ secrets.MAC_CERTIFICATE_PASSWORD }}

      - name: Notarize macOS ARM64 app
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          if [ -z "$APPLE_ID" ]; then
            echo "Skipping notarization: APPLE_ID not configured"
            exit 0
          fi
          cd apps/frontend
          for dmg in dist/*.dmg; do
            echo "Notarizing $dmg..."
            xcrun notarytool submit "$dmg" \
              --apple-id "$APPLE_ID" \
              --password "$APPLE_APP_SPECIFIC_PASSWORD" \
              --team-id "$APPLE_TEAM_ID" \
              --wait
            xcrun stapler staple "$dmg"
            echo "Successfully notarized and stapled $dmg"
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64-builds
          path: |
            apps/frontend/dist/*.dmg
            apps/frontend/dist/*.zip

  build-windows:
    needs: update-version
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          # Use tag for real releases, develop branch for dry runs
          ref: ${{ github.event.inputs.dry_run == 'true' && 'develop' || format('v{0}', needs.update-version.outputs.version) }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Get npm cache directory
        id: npm-cache
        shell: bash
        run: echo "dir=$(npm config get cache)" >> $GITHUB_OUTPUT

      - uses: actions/cache@v4
        with:
          path: ${{ steps.npm-cache.outputs.dir }}
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: ${{ runner.os }}-npm-

      - name: Install dependencies
        run: cd apps/frontend && npm ci

      - name: Cache bundled Python
        uses: actions/cache@v4
        with:
          path: apps/frontend/python-runtime
          key: python-bundle-${{ runner.os }}-x64-3.12.8
          restore-keys: |
            python-bundle-${{ runner.os }}-x64-

      - name: Build application
        run: cd apps/frontend && npm run build

      - name: Package Windows
        run: cd apps/frontend && npm run package:win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_LINK: ${{ secrets.WIN_CERTIFICATE }}
          CSC_KEY_PASSWORD: ${{ secrets.WIN_CERTIFICATE_PASSWORD }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-builds
          path: |
            apps/frontend/dist/*.exe

  build-linux:
    needs: update-version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          # Use tag for real releases, develop branch for dry runs
          ref: ${{ github.event.inputs.dry_run == 'true' && 'develop' || format('v{0}', needs.update-version.outputs.version) }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Get npm cache directory
        id: npm-cache
        run: echo "dir=$(npm config get cache)" >> $GITHUB_OUTPUT

      - uses: actions/cache@v4
        with:
          path: ${{ steps.npm-cache.outputs.dir }}
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: ${{ runner.os }}-npm-

      - name: Install dependencies
        run: cd apps/frontend && npm ci

      - name: Cache bundled Python
        uses: actions/cache@v4
        with:
          path: apps/frontend/python-runtime
          key: python-bundle-${{ runner.os }}-x64-3.12.8
          restore-keys: |
            python-bundle-${{ runner.os }}-x64-

      - name: Build application
        run: cd apps/frontend && npm run build

      - name: Package Linux
        run: cd apps/frontend && npm run package:linux
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-builds
          path: |
            apps/frontend/dist/*.AppImage
            apps/frontend/dist/*.deb

  create-release:
    needs: [update-version, build-macos-intel, build-macos-arm64, build-windows, build-linux]
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.dry_run != 'true' }}
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: v${{ needs.update-version.outputs.version }}
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Flatten and validate artifacts
        run: |
          mkdir -p release-assets
          find dist -type f \( -name "*.dmg" -o -name "*.zip" -o -name "*.exe" -o -name "*.AppImage" -o -name "*.deb" \) -exec cp {} release-assets/ \;

          # Validate that at least one artifact was copied
          artifact_count=$(find release-assets -type f \( -name "*.dmg" -o -name "*.zip" -o -name "*.exe" -o -name "*.AppImage" -o -name "*.deb" \) | wc -l)
          if [ "$artifact_count" -eq 0 ]; then
            echo "::error::No build artifacts found! Expected .dmg, .zip, .exe, .AppImage, or .deb files."
            exit 1
          fi

          echo "Found $artifact_count artifact(s):"
          ls -la release-assets/

      - name: Generate checksums
        run: |
          cd release-assets
          sha256sum ./* > checksums.sha256
          cat checksums.sha256

      - name: Create Beta Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.update-version.outputs.version }}
          name: v${{ needs.update-version.outputs.version }} (Beta)
          body: |
            ## Beta Release v${{ needs.update-version.outputs.version }}

            This is a **beta release** for testing new features. It may contain bugs or incomplete functionality.

            ### How to opt-in to beta updates
            1. Open Auto Claude
            2. Go to Settings > Updates
            3. Enable "Beta Updates" toggle

            ### Reporting Issues
            Please report any issues at https://github.com/AndyMik90/Auto-Claude/issues

            ---

            **Full Changelog**: https://github.com/${{ github.repository }}/compare/main...v${{ needs.update-version.outputs.version }}
          files: release-assets/*
          draft: false
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  dry-run-summary:
    needs: [update-version, build-macos-intel, build-macos-arm64, build-windows, build-linux]
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.dry_run == 'true' }}
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Dry run summary
        run: |
          echo "## Beta Release Dry Run Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.update-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Build artifacts created successfully:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          find dist -type f \( -name "*.dmg" -o -name "*.zip" -o -name "*.exe" -o -name "*.AppImage" -o -name "*.deb" \) >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To create a real release, run this workflow again with dry_run unchecked." >> $GITHUB_STEP_SUMMARY
