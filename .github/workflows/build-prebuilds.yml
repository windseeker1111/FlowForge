name: Build Native Module Prebuilds

on:
  # Build on releases
  release:
    types: [published]
  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      electron_version:
        description: 'Electron version to build for'
        required: false
        default: '39.2.6'

env:
  # Default Electron version - update when upgrading Electron in package.json
  ELECTRON_VERSION: ${{ github.event.inputs.electron_version || '39.2.6' }}

jobs:
  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x64]
        # Add arm64 when GitHub Actions supports Windows ARM runners
        # arch: [x64, arm64]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'

      - name: Install Visual Studio Build Tools
        uses: microsoft/setup-msbuild@v2

      - name: Install node-pty and rebuild for Electron
        working-directory: apps/frontend
        shell: pwsh
        run: |
          # Install only node-pty
          npm install node-pty@1.1.0-beta42

          # Get Electron ABI version
          $electronAbi = (npx electron-abi $env:ELECTRON_VERSION)
          Write-Host "Building for Electron $env:ELECTRON_VERSION (ABI: $electronAbi)"

          # Rebuild node-pty for Electron
          npx @electron/rebuild --version $env:ELECTRON_VERSION --module-dir node_modules/node-pty --arch ${{ matrix.arch }}

      - name: Package prebuilt binaries
        working-directory: apps/frontend
        shell: pwsh
        run: |
          $electronAbi = (npx electron-abi $env:ELECTRON_VERSION)
          $prebuildDir = "prebuilds/win32-${{ matrix.arch }}-electron-$electronAbi"

          New-Item -ItemType Directory -Force -Path $prebuildDir

          # Copy all built native files
          $buildDir = "node_modules/node-pty/build/Release"
          if (Test-Path $buildDir) {
            Copy-Item "$buildDir/*.node" $prebuildDir/ -Force
            Copy-Item "$buildDir/*.dll" $prebuildDir/ -Force -ErrorAction SilentlyContinue
            Copy-Item "$buildDir/*.exe" $prebuildDir/ -Force -ErrorAction SilentlyContinue

            # Also copy conpty files if they exist in subdirectory
            if (Test-Path "$buildDir/conpty") {
              Copy-Item "$buildDir/conpty/*" $prebuildDir/ -Force
            }
          }

          # List what we packaged
          Write-Host "Packaged prebuilds:"
          Get-ChildItem $prebuildDir

      - name: Create archive
        working-directory: apps/frontend
        shell: pwsh
        run: |
          $electronAbi = (npx electron-abi $env:ELECTRON_VERSION)
          $archiveName = "node-pty-win32-${{ matrix.arch }}-electron-$electronAbi.zip"

          Compress-Archive -Path "prebuilds/*" -DestinationPath $archiveName

          Write-Host "Created archive: $archiveName"
          Get-ChildItem $archiveName

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: node-pty-win32-${{ matrix.arch }}
          path: apps/frontend/node-pty-*.zip
          retention-days: 90

      - name: Upload to release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: apps/frontend/node-pty-*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Create a combined prebuilds package
  package-prebuilds:
    needs: build-windows
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: |
          echo "Downloaded artifacts:"
          find artifacts -type f -name "*.zip"

      - name: Upload combined artifact
        uses: actions/upload-artifact@v4
        with:
          name: node-pty-prebuilds-all
          path: artifacts/**/*.zip
          retention-days: 90
