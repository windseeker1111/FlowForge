repos:
  # Version sync - propagate root package.json version to all files
  # NOTE: Skip in worktrees - version sync modifies root files which don't exist in worktree
  - repo: local
    hooks:
      - id: version-sync
        name: Version Sync
        entry: bash
        args:
          - -c
          - |
            # Skip in worktrees - .git is a file pointing to main repo, not a directory
            # Version sync modifies root-level files that may not exist in worktree context
            if [ -f ".git" ]; then
              echo "Skipping version-sync in worktree (root files not accessible)"
              exit 0
            fi
            VERSION=$(node -p "require('./package.json').version")
            if [ -n "$VERSION" ]; then

              # Sync to apps/frontend/package.json
              node -e "
                const fs = require('fs');
                const p = require('./apps/frontend/package.json');
                const v = process.argv[1];
                if (p.version !== v) {
                  p.version = v;
                  fs.writeFileSync('./apps/frontend/package.json', JSON.stringify(p, null, 2) + '\n');
                }
              " "$VERSION"

              # Sync to apps/backend/__init__.py
              sed -i.bak "s/__version__ = \"[^\"]*\"/__version__ = \"$VERSION\"/" apps/backend/__init__.py && rm -f apps/backend/__init__.py.bak

              # Sync to README.md - section-aware updates (stable vs beta)
              ESCAPED_VERSION=$(echo "$VERSION" | sed 's/-/--/g')

              # Detect if this is a prerelease (contains - after base version)
              if echo "$VERSION" | grep -q '-'; then
                # PRERELEASE: Update only beta sections
                echo "  Detected PRERELEASE version: $VERSION"

                # Update beta version badge (orange)
                sed -i.bak "s/beta-[0-9]*\.[0-9]*\.[0-9]*\(--[a-z]*\.[0-9]*\)*-orange/beta-$ESCAPED_VERSION-orange/g" README.md

                # Update beta version badge link
                sed -i.bak '/<!-- BETA_VERSION_BADGE -->/,/<!-- BETA_VERSION_BADGE_END -->/s|releases/tag/v[0-9.a-z-]*)|releases/tag/v'"$VERSION"')|g' README.md

                # Update beta download links (within BETA_DOWNLOADS section only)
                for SUFFIX in "win32-x64.exe" "darwin-arm64.dmg" "darwin-x64.dmg" "linux-x86_64.AppImage" "linux-amd64.deb" "linux-x86_64.flatpak"; do
                  sed -i.bak '/<!-- BETA_DOWNLOADS -->/,/<!-- BETA_DOWNLOADS_END -->/{s|Auto-Claude-[0-9.a-z-]*-'"$SUFFIX"'](https://github.com/AndyMik90/Auto-Claude/releases/download/v[^/]*/Auto-Claude-[^)]*-'"$SUFFIX"')|Auto-Claude-'"$VERSION"'-'"$SUFFIX"'](https://github.com/AndyMik90/Auto-Claude/releases/download/v'"$VERSION"'/Auto-Claude-'"$VERSION"'-'"$SUFFIX"')|g}' README.md
                done
              else
                # STABLE: Update stable sections and top badge
                echo "  Detected STABLE version: $VERSION"

                # Update top version badge (blue)
                sed -i.bak '/<!-- TOP_VERSION_BADGE -->/,/<!-- TOP_VERSION_BADGE_END -->/s/version-[0-9]*\.[0-9]*\.[0-9]*\(--[a-z]*\.[0-9]*\)*-blue/version-'"$ESCAPED_VERSION"'-blue/g' README.md
                sed -i.bak '/<!-- TOP_VERSION_BADGE -->/,/<!-- TOP_VERSION_BADGE_END -->/s|releases/tag/v[0-9.a-z-]*)|releases/tag/v'"$VERSION"')|g' README.md

                # Update stable version badge (blue)
                sed -i.bak '/<!-- STABLE_VERSION_BADGE -->/,/<!-- STABLE_VERSION_BADGE_END -->/s/stable-[0-9]*\.[0-9]*\.[0-9]*\(--[a-z]*\.[0-9]*\)*-blue/stable-'"$ESCAPED_VERSION"'-blue/g' README.md
                sed -i.bak '/<!-- STABLE_VERSION_BADGE -->/,/<!-- STABLE_VERSION_BADGE_END -->/s|releases/tag/v[0-9.a-z-]*)|releases/tag/v'"$VERSION"')|g' README.md

                # Update stable download links (within STABLE_DOWNLOADS section only)
                for SUFFIX in "win32-x64.exe" "darwin-arm64.dmg" "darwin-x64.dmg" "linux-x86_64.AppImage" "linux-amd64.deb"; do
                  sed -i.bak '/<!-- STABLE_DOWNLOADS -->/,/<!-- STABLE_DOWNLOADS_END -->/{s|Auto-Claude-[0-9.a-z-]*-'"$SUFFIX"'](https://github.com/AndyMik90/Auto-Claude/releases/download/v[^/]*/Auto-Claude-[^)]*-'"$SUFFIX"')|Auto-Claude-'"$VERSION"'-'"$SUFFIX"'](https://github.com/AndyMik90/Auto-Claude/releases/download/v'"$VERSION"'/Auto-Claude-'"$VERSION"'-'"$SUFFIX"')|g}' README.md
                done
              fi
              rm -f README.md.bak

              # Stage changes
              git add apps/frontend/package.json apps/backend/__init__.py README.md 2>/dev/null || true
            fi
        language: system
        files: ^package\.json$
        pass_filenames: false

  # Python encoding check - prevent regression of UTF-8 encoding fixes (PR #782)
  - repo: local
    hooks:
      - id: check-file-encoding
        name: Check file encoding parameters
        entry: python scripts/check_encoding.py
        language: system
        types: [python]
        files: ^apps/backend/
        description: Ensures all file operations specify encoding="utf-8"

  # Python linting (apps/backend/)
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.14.10
    hooks:
      - id: ruff
        args: [--fix]
        files: ^apps/backend/
      - id: ruff-format
        files: ^apps/backend/

  # Python tests (apps/backend/) - skip slow/integration tests for pre-commit speed
  # Tests to skip: graphiti (external deps), merge_file_tracker/service_orchestrator/worktree/workspace (Windows path/git issues)
  # NOTE: Skip this hook in worktrees (where .git is a file, not a directory)
  - repo: local
    hooks:
      - id: pytest
        name: Python Tests
        entry: bash
        args:
          - -c
          - |
            # Skip in worktrees - .git is a file pointing to main repo, not a directory
            # This prevents path resolution issues with ../../tests/ in worktree context
            if [ -f ".git" ]; then
              echo "Skipping pytest in worktree (path resolution would fail)"
              exit 0
            fi
            cd apps/backend
            if [ -f ".venv/bin/pytest" ]; then
              PYTEST_CMD=".venv/bin/pytest"
            elif [ -f ".venv/Scripts/pytest.exe" ]; then
              PYTEST_CMD=".venv/Scripts/pytest.exe"
            else
              PYTEST_CMD="python -m pytest"
            fi
            PYTHONPATH=. $PYTEST_CMD \
              ../../tests/ \
              -v \
              --tb=short \
              -x \
              -m "not slow and not integration" \
              --ignore=../../tests/test_graphiti.py \
              --ignore=../../tests/test_merge_file_tracker.py \
              --ignore=../../tests/test_service_orchestrator.py \
              --ignore=../../tests/test_worktree.py \
              --ignore=../../tests/test_workspace.py
        language: system
        files: ^(apps/backend/.*\.py$|tests/.*\.py$)
        pass_filenames: false

  # Frontend linting (apps/frontend/) - Biome is 15-25x faster than ESLint
  # NOTE: These hooks check for worktree context to avoid npm/node_modules issues
  - repo: local
    hooks:
      - id: biome
        name: Biome (lint + format)
        entry: bash
        args:
          - -c
          - |
            # Skip in worktrees if node_modules doesn't exist (Biome not installed)
            if [ -f ".git" ] && [ ! -d "apps/frontend/node_modules" ]; then
              echo "Skipping Biome in worktree (node_modules not found)"
              exit 0
            fi
            cd apps/frontend && npx biome check --write --no-errors-on-unmatched .
        language: system
        files: ^apps/frontend/.*\.(ts|tsx|js|jsx|json)$
        pass_filenames: false

      - id: typecheck
        name: TypeScript Check
        entry: bash
        args:
          - -c
          - |
            # Skip in worktrees if node_modules doesn't exist (dependencies not installed)
            if [ -f ".git" ] && [ ! -d "apps/frontend/node_modules" ]; then
              echo "Skipping TypeScript check in worktree (node_modules not found)"
              exit 0
            fi
            cd apps/frontend && npm run typecheck
        language: system
        files: ^apps/frontend/.*\.(ts|tsx)$
        pass_filenames: false

  # General checks
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      - id: trailing-whitespace
      - id: end-of-file-fixer
      - id: check-yaml
        exclude: pnpm-lock\.yaml$
      - id: check-added-large-files
